name: Run Stock Recommendation Notebooks

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch:

jobs:
  run-notebooks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install jupyter nbconvert papermill pandas numpy matplotlib seaborn yfinance ipywidgets

    - name: Prepare folders
      run: mkdir -p generated

    - name: Run Notebook 02
      run: |
        papermill "02-daily_stock_recommendations_yahoo.ipynb" \
          "generated/02_executed_$(date +'%Y%m%d_%H%M%S').ipynb"

    - name: Run Notebook 03
      run: |
        papermill "03-average_stock_recommendations_yahoo.ipynb" \
          "generated/03_executed_$(date +'%Y%m%d_%H%M%S').ipynb"

    - name: Run Notebook 04
      run: |
        papermill "04-hotscore_stock_recommendations_yahoo.ipynb" \
          "generated/04_executed_$(date +'%Y%m%d_%H%M%S').ipynb"

    - name: Commit output files
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add generated/*.ipynb || true

        # commit only if something changed
        if ! git diff --cached --quiet; then
          git commit -m "Auto-run notebooks $(date)"
          git push
        else
          echo "No changes to commit"
        fi
