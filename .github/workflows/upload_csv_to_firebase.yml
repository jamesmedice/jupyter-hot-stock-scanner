name: 6 - Upload CSVs to Firebase

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Firebase Admin SDK
        run: |
          python -m pip install --upgrade pip
          pip install firebase-admin

      - name: Upload CSVs to Firebase Storage
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          python << 'EOF'
          import os
          import json
          import glob
          import firebase_admin
          from firebase_admin import credentials, storage

          # Load credentials from GitHub Secret
          cred_info = json.loads(os.environ["FIREBASE_SERVICE_ACCOUNT"])
          cred = credentials.Certificate(cred_info)

          # Initialize Firebase
          firebase_admin.initialize_app(cred, {
              "storageBucket": "tpmedici.appspot.com"
          })

          bucket = storage.bucket()
          folder = "market/"

          # Folders to upload
          paths = [
              "data/averages/*.csv",
              "data/hotscore/*.csv",
              "output/recommendations/*.csv"
          ]

          for pattern in paths:
              for f in glob.glob(pattern):
                  filename = os.path.basename(f)
                  blob = bucket.blob(folder + filename)
                  blob.upload_from_filename(f)
                  print(f"Uploaded {f} â†’ {folder}{filename}")
          EOF
