name: 6 - Upload CSVs to Firebase

on:
  workflow_dispatch:   # manual trigger
  # optionally, schedule:
  # schedule:
  #   - cron: "0 0 * * *"  # daily at midnight

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install firebase-admin

      - name: Upload CSVs to Firebase Storage
        run: |
          python - <<'END'
                    import os
                    import json
                    import glob
                    import firebase_admin
                    from firebase_admin import credentials, storage

                    cred_json = os.environ['FIREBASE_SERVICE_ACCOUNT']
                    cred = credentials.Certificate(json.loads(cred_json))

                    firebase_admin.initialize_app(cred, {
                        'storageBucket': 'tpmedici.appspot.com'
                    })

                    bucket = storage.bucket()
                    folder = 'market/'

                    paths = [
                        'data/averages/*.csv',
                        'data/hotscore/*.csv',
                        'output/recommendations/*.csv'
                    ]

                    for pattern in paths:
                        for f in glob.glob(pattern):
                            blob = bucket.blob(folder + os.path.basename(f))
                            blob.upload_from_filename(f)
                            print(f"Uploaded {f} to {folder}{os.path.basename(f)}")
          END
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
