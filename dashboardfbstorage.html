<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HotStock Dashboard - Firebase</title>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage-compat.js"></script>
<script src="https://cdn.plot.ly/plotly-2.26.1.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
.tabs { display: flex; cursor: pointer; margin-bottom: 10px; }
.tab { padding: 10px 20px; border: 1px solid #ccc; border-bottom: none; background: #f0f0f0; }
.tab.active { background: white; font-weight: bold; }
.tab-content { border: 1px solid #ccc; padding: 10px; display: none; }
.tab-content.active { display: block; }
.chart { width: 100%; height: 400px; margin-top: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
th { background-color: #f0f0f0; }
</style>
</head>
<body>

<h1>HotStock Dashboard</h1>

<label for="dateSelect">Select Date:</label>
<select id="dateSelect"></select>
<button id="loadBtn">Load Data</button>

<div class="tabs">
  <div class="tab active" data-tab="daily">Daily HotStocks</div>
  <div class="tab" data-tab="averages">Averages</div>
  <div class="tab" data-tab="hotscore">HotScore</div>
</div>

<div id="daily" class="tab-content active">
  <div id="dailyChart" class="chart"></div>
  <div id="dailyTable"></div>
</div>

<div id="averages" class="tab-content">
  <div id="avgChart" class="chart"></div>
  <div id="avgTable"></div>
</div>

<div id="hotscore" class="tab-content">
  <div id="hotscoreChart" class="chart"></div>
  <div id="hotscoreTable"></div>
</div>

<script>
// --- Firebase Config ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

// --- Tabs ---
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// --- Helper: fetch CSV from Firebase Storage ---
async function fetchCSV(path) {
  try {
    const ref = storage.ref(path);
    const url = await ref.getDownloadURL();
    const resp = await fetch(url);
    const text = await resp.text();
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows.shift();
    return rows.map(r => Object.fromEntries(r.map((v,i) => [headers[i],v])));
  } catch (e) {
    console.error("CSV fetch error", e);
    return [];
  }
}

// --- Populate available dates dynamically ---
async function getAvailableDates(folder) {
  const listRef = storage.ref(folder);
  try {
    const res = await listRef.listAll();
    return res.items.map(i => i.name.match(/\d+/)[0]);  // extract date from filename
  } catch(e) {
    console.error(e);
    return [];
  }
}

// --- Load Data ---
document.getElementById("loadBtn").addEventListener("click", async () => {
  const date = document.getElementById("dateSelect").value;
  if (!date) return alert("Select a date first.");

  const daily = await fetchCSV(`daily/hot_stocks_${date}.csv`);
  const averages = await fetchCSV(`averages/avg_${date}.csv`);
  const hotscore = await fetchCSV(`hotscore/hotscore_${date}.csv`);

  // --- Daily Chart & Table ---
  if (daily.length) {
    const symbols = daily.map(r=>r.symbol), scores = daily.map(r=>parseFloat(r.HotScore));
    Plotly.newPlot('dailyChart', [{x:symbols, y:scores, type:'bar', marker:{color:'blue'}}],
      {title:`Daily HotStocks - ${date}`, xaxis:{title:"Symbol"}, yaxis:{title:"HotScore"}});
    
    const dailyTable = document.getElementById("dailyTable");
    dailyTable.innerHTML = "<h3>Top Daily HotStocks</h3>" + tableHTML(daily, 20);
  }

  // --- Averages Chart & Table ---
  if (averages.length) {
    const symbols = averages.map(r=>r.symbol), scores = averages.map(r=>parseFloat(r.HotScore));
    Plotly.newPlot('avgChart', [{x:symbols, y:scores, type:'bar', marker:{color:'green'}}],
      {title:`Average HotScore - ${date}`, xaxis:{title:"Symbol"}, yaxis:{title:"Avg HotScore"}});
    
    document.getElementById("avgTable").innerHTML = "<h3>Top Averages</h3>" + tableHTML(averages, 20);
  }

  // --- HotScore Chart & Table ---
  if (hotscore.length) {
    const symbols = hotscore.map(r=>r.symbol), scores = hotscore.map(r=>parseFloat(r.HotScore));
    Plotly.newPlot('hotscoreChart', [{x:symbols, y:scores, type:'bar', marker:{color:'orange'}}],
      {title:`HotScore Top Symbols - ${date}`, xaxis:{title:"Symbol"}, yaxis:{title:"HotScore"}});
    
    document.getElementById("hotscoreTable").innerHTML = "<h3>HotScore Table</h3>" + tableHTML(hotscore, 20);
  }
});

// --- Helper to generate HTML table ---
function tableHTML(data, topN=20) {
  const headers = Object.keys(data[0]);
  let html = "<table><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  html += data.slice(0, topN).map(r=>"<tr>"+Object.values(r).map(v=>`<td>${v}</td>`).join("")+"</tr>").join("");
  html += "</table>";
  return html;
}

// --- Populate date dropdown on load ---
(async () => {
  const dates = await getAvailableDates("daily");
  const select = document.getElementById("dateSelect");
  select.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join("");
})();
</script>

</body>
</html>
